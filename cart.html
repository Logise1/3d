<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print3D Store - Mis Pedidos</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Carga de estilos CSS externos -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- (NUEVO) Estilos del Loader (copiado de home) -->
    <style>
        .loader {
            border: 4px solid #f3f4f6; /* gray-100 */
            border-top: 4px solid #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* (NUEVO) Estilos para la barra de navegación móvil inferior */
        .mobile-nav-link {
            flex: 1 1 0%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            color: #6b7280; /* text-gray-500 */
            transition: color 0.15s ease-in-out;
        }
        .mobile-nav-link:hover {
            color: #374151; /* text-gray-700 */
        }
        .mobile-nav-link.active {
            color: #2563eb; /* text-blue-600 */
        }
        .mobile-nav-link svg {
            margin-bottom: 0.25rem;
        }
    </style>

</head>
<body class="antialiased text-gray-800 bg-gray-100">

    <!-- Contenedor principal de la App (Oculto hasta que se verifique auth) -->
    <div id="app-container" class="min-h-screen hidden">

        <!-- 
          Barra de Navegación Móvil (visible en móvil) 
        -->
        <nav class="bg-white shadow-md sticky top-0 z-20 sm:hidden">
            <div class="container mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Título -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="w-8 h-8 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        <span class="font-bold text-xl text-gray-900">Print3D</span>
                    </div>
                    <!-- Info de Usuario (Saldo en Euros) -->
                    <div class="flex items-center">
                        <div class="flex items-center bg-green-100 text-green-800 rounded-full px-3 py-1.5">
                            <svg class="w-5 h-5 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756c.386.19.74.42 1.05.684m0 0c.31.264.59.558.82.88m0 0a8.966 8.966 0 011.606 3.056m0 0a8.966 8.966 0 01-1.606 3.056m0 0c-.23.322-.51.616-.82.88m0 0c-.31.264-.664.493-1.05.684m0 0a8.966 8.966 0 01-2.1 1.32m0 0a8.966 8.966 0 01-2.1-1.32m0 0c-.386-.19-.74-.42-1.05-.684m0 0c-.31-.264-.59-.558-.82-.88m0 0a8.966 8.966 0 01-1.606-3.056m0 0a8.966 8.966 0 011.606-3.056m0 0c.23-.322.51-.616.82-.88m0 0c.31-.264.664.493 1.05-.684m0 0a8.966 8.966 0 012.1-1.32m0 0a8.966 8.966 0 012.1 1.32M4.5 12h15M4.5 9.75h15M4.5 14.25h15" /></svg>
                            <span id="user-coins-mobile" class="font-bold text-sm">...</span>
                        </div>
                        <button id="logout-btn-mobile" class="ml-3 text-sm font-medium text-gray-500 hover:text-gray-700">Salir</button>
                    </div>
                </div>
            </div>
            <!-- Info de Usuario y Carga (para mostrar mientras se conecta) -->
            <div class="bg-gray-100 py-2 px-4 border-t border-gray-200">
                <div class="container mx-auto flex justify-between items-center text-xs text-gray-600">
                    <span id="auth-status-mobile">Verificando...</span>
                </div>
            </div>
        </nav>

        <!-- Barra de Navegación (visible en escritorio) -->
        <nav class="bg-white shadow-md sticky top-0 z-20 hidden sm:block">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo/Título -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="w-8 h-8 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        <span class="font-bold text-xl text-gray-900">Print3D Store</span>
                    </div>
                    
                    <!-- Enlaces de Navegación -->
                    <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                        <a href="home.html" id="nav-store" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Tienda
                        </a>
                        <a href="cart.html" id="nav-orders" class="nav-link border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Mis Pedidos
                        </a>
                        <a href="personalize.html" id="nav-personalize" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Personalizar
                        </a>
                         <!-- (NUEVO) Enlace Chat -->
                        <a href="chat.html" id="nav-chat" class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Chat
                        </a>
                        <!-- Pestaña de Admin Pedidos -->
                        <a href="home.html" id="nav-admin-orders" class="nav-link hidden border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                            Pedidos (Admin)
                        </a>
                    </div>

                    <!-- Info de Usuario (Saldo en Euros) -->
                    <div class="flex items-center">
                        <div class="flex items-center bg-green-100 text-green-800 rounded-full px-4 py-1.5 mr-4">
                             <svg class="w-5 h-5 mr-1.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756c.386.19.74.42 1.05.684m0 0c.31.264.59.558.82.88m0 0a8.966 8.966 0 011.606 3.056m0 0a8.966 8.966 0 01-1.606 3.056m0 0c-.23.322-.51.616-.82.88m0 0c-.31.264-.664.493-1.05.684m0 0a8.966 8.966 0 01-2.1 1.32m0 0a8.966 8.966 0 01-2.1-1.32m0 0c-.386-.19-.74-.42-1.05-.684m0 0c-.31-.264-.59-.558-.82-.88m0 0a8.966 8.966 0 01-1.606-3.056m0 0a8.966 8.966 0 011.606-3.056m0 0c.23-.322.51-.616.82-.88m0 0c.31-.264.664.493 1.05-.684m0 0a8.966 8.966 0 012.1-1.32m0 0a8.966 8.966 0 012.1 1.32M4.5 12h15M4.5 9.75h15M4.5 14.25h15" /></svg>
                            <span class="text-sm font-medium mr-1">Saldo:</span>
                            <span id="user-coins" class="font-bold text-sm">...</span>
                        </div>
                        <button id="logout-btn" class="text-sm font-medium text-gray-500 hover:text-gray-700">Cerrar Sesión</button>
                    </div>
                </div>
            </div>
            <!-- Info de Usuario y Carga (para mostrar mientras se conecta) -->
            <div class="bg-gray-100 py-2 px-4 sm:px-6 lg:px-8 border-t border-gray-200">
                <div class="container mx-auto flex justify-between items-center text-xs text-gray-600">
                    <span id="auth-status">Verificando...</span>
                </div>
            </div>
        </nav>

        <!-- Contenido Principal -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 pb-24 sm:pb-8">

            <!-- Vista de Mis Pedidos (Visible por defecto) -->
            <div id="orders-view">
                <h1 class="text-3xl font-bold text-gray-900 mb-6">Mis Pedidos</h1>
                
                <!-- (NUEVO) Mensaje de Cancelación -->
                <div id="cancel-message" class="hidden mb-4 p-3 rounded-md text-sm"></div>

                <!-- Spinner de Carga de Pedidos -->
                <div id="orders-loading" class="flex justify-center items-center h-64">
                    <div class="loader"></div>
                </div>

                <!-- Lista de Pedidos -->
                <div id="orders-list" class="space-y-4">
                    <!-- Los pedidos se insertarán aquí por JS -->
                </div>
            </div>

        </main>
    </div>

    <!-- Barra de Navegación Móvil (Inferior) -->
    <nav id="mobile-nav" class="sm:hidden fixed bottom-0 left-0 right-0 h-16 bg-white border-t border-gray-200 flex z-30">
        <!-- Enlace Mis Pedidos -->
        <a href="cart.html" id="mobile-nav-orders" class="mobile-nav-link active">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span class="text-xs">Mis Pedidos</span>
        </a>
        
        <!-- Enlace Tienda (Home) -->
        <a href="home.html" id="mobile-nav-store" class="mobile-nav-link">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span class="text-xs">Tienda</span>
        </a>

        <!-- Enlace Personalizar -->
        <a href="personalize.html" id="mobile-nav-personalize" class="mobile-nav-link">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
            <span class="text-xs">Personalizar</span>
        </a>

        <!-- (NUEVO) Enlace Chat -->
        <a href="chat.html" id="mobile-nav-chat" class="mobile-nav-link">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            <span class="text-xs">Chat</span>
        </a>
        
        <!-- Enlace Pedidos (Admin) -->
        <a href="home.html" id="mobile-nav-admin-orders" class="mobile-nav-link hidden">
            <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <span class="text-xs">Admin</span>
        </a>
    </nav>

    <!-- (NUEVO) Botón Flotante de Chat -->
    <!-- 'bottom-20' para que esté SOBRE la barra de nav móvil -->
    <a href="chat.html" 
       class="fixed bottom-20 sm:bottom-6 right-6 z-40 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-all duration-200"
       title="Abrir Chat">
        <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </a>


    <!-- Script de Firebase -->
    <script type="module">
        // Importar funciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            onSnapshot, 
            query,
            setLogLevel,
            updateDoc, // (NUEVO)
            deleteDoc, // (NUEVO)
            getDoc // (NUEVO)
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuración de Firebase ---
        const firebaseConfig = {
          apiKey: "AIzaSyCSjDd3NUX08_G2QySl7ce0kS9kYiXfKfw",
          authDomain: "dprinting-9b264.firebaseapp.com",
          projectId: "dprinting-9b264",
          storageBucket: "dprinting-9b264.firebasestorage.app",
          messagingSenderId: "647333546063",
          appId: "1:647333546063:web:d2cb20940e76c913c5c23a",
          measurementId: "G-FWKS2HB1SE"
        };
        
        const appId = firebaseConfig.projectId || 'default-app-id';
        const adminEmails = ['arielcapdevilagarcia@gmail.com', 'cloenarvaez@gmail.com']; // (MODIFICADO)

        // Inicializar Firebase
        let app, db, auth;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('Debug');
            console.log("Firebase inicializado correctamente.");
        } catch (error) {
            console.error("Error al inicializar Firebase:", error);
            document.getElementById('auth-status').textContent = 'Error al conectar con Firebase.';
            document.getElementById('auth-status-mobile').textContent = 'Error al conectar con Firebase.';
        }

        // --- Variables de Estado de la App ---
        let userId = null;
        let currentUserEmail = null; 
        let currentUserCoins = 0;
        let countdownInterval = null; // (NUEVO) Intervalo para la cuenta atrás
        
        // --- Elementos del DOM ---
        // Headers Escritorio
        const authStatus = document.getElementById('auth-status');
        const userCoinsDisplay = document.getElementById('user-coins');
        const logoutBtn = document.getElementById('logout-btn');
        
        // Headers Móvil (NUEVO)
        const authStatusMobile = document.getElementById('auth-status-mobile');
        const userCoinsMobile = document.getElementById('user-coins-mobile');
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        
        // Contenedor
        const appContainer = document.getElementById('app-container');

        // Navegación
        const navAdminOrders = document.getElementById('nav-admin-orders'); 
        const mobileNavAdminOrders = document.getElementById('mobile-nav-admin-orders');
        
        // Pedidos
        const ordersList = document.getElementById('orders-list');
        const ordersLoading = document.getElementById('orders-loading');
        const cancelMessage = document.getElementById('cancel-message'); // (NUEVO)

        // --- Lógica de Autenticación (Protección de Ruta) ---

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Usuario está conectado
                userId = user.uid;
                currentUserEmail = user.email; 
                const statusText = `Conectado como: ${user.email}`;
                authStatus.textContent = statusText;
                authStatusMobile.textContent = statusText; // (NUEVO)
                
                appContainer.style.display = 'block'; // Mostrar app
                
                await setupUserListeners(userId);

                // Comprobar si es admin para mostrar el enlace de admin
                navAdminOrders.style.display = 'none';
                mobileNavAdminOrders.style.display = 'none';
                if (adminEmails.includes(currentUserEmail)) { // (MODIFICADO)
                    navAdminOrders.style.display = 'inline-flex'; 
                    mobileNavAdminOrders.style.display = 'flex'; 
                }
                
            } else {
                // Usuario está desconectado, redirigir a login
                console.log("Usuario no logueado, redirigiendo a login.html");
                window.location.href = 'login.html';
            }
        });

        // Manejar click de Cerrar Sesión (ambos botones)
        const handleSignOut = async () => {
            try {
                await signOut(auth);
                // onAuthStateChanged se activará y redirigirá a login.html
            } catch (error)
                {
                console.error("Error al cerrar sesión:", error);
            }
        };
        logoutBtn.addEventListener('click', handleSignOut);
        logoutBtnMobile.addEventListener('click', handleSignOut); // (NUEVO)


        // --- Lógica de Firestore (Listeners en tiempo real) ---

        async function setupUserListeners(currentUserId) {
            if (!currentUserId) return;

            // 1. Listener para el perfil del usuario (monedas)
            const userProfileRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/profile/data`);
            
            onSnapshot(userProfileRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentUserCoins = data.coins || 0; // Guardar como monedas
                    // (MODIFICADO) Mostrar como Euros
                    const userBalanceEuros = (currentUserCoins / 250).toFixed(2);
                    userCoinsDisplay.textContent = `${userBalanceEuros}€`;
                    userCoinsMobile.textContent = `${userBalanceEuros}€`;
                } else {
                   console.error("Error: Perfil de usuario no encontrado.");
                   userCoinsDisplay.textContent = '0.00€';
                   userCoinsMobile.textContent = '0.00€';
                }
            }, (error) => {
                console.error("Error en listener de perfil:", error);
            });

            // 2. Listener para los pedidos del usuario (privado)
            const userOrdersRef = collection(db, `/artifacts/${appId}/users/${currentUserId}/orders`);
            onSnapshot(query(userOrdersRef), (snapshot) => {
                renderOrders(snapshot.docs);
                ordersLoading.style.display = 'none';
                
                // (NUEVO) Iniciar/reiniciar el intervalo de cuenta atrás
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(updateAllCountdowns, 1000);

            }, (error) => {
                console.error("Error en listener de pedidos:", error);
                ordersLoading.innerHTML = '<p class="text-red-500">Error al cargar tus pedidos.</p>';
            });
        }

        // --- (NUEVO) Lógica de Cuenta Atrás ---

        function formatDuration(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            // (MODIFICADO) Formato más legible
            let parts = [];
            if (hours > 0) parts.push(`${hours}h`);
            if (minutes > 0) parts.push(`${minutes}m`);
            if (hours === 0 && minutes === 0) parts.push(`${seconds}s`); // Solo mostrar segundos si es menos de 1 min

            if (parts.length === 0) return "0s"; // Caso de 0 segundos
            
            // Si hay horas y minutos, solo mostrar esos (ej. 1h 30m)
            if (hours > 0 && minutes > 0) {
                 return parts.slice(0, 2).join(' ');
            }
            // Si solo hay minutos, o solo horas (ej. 1h, 30m)
            return parts.join(' ');
        }

        function updateAllCountdowns() {
            const now = Date.now();
            const timers = document.querySelectorAll('.countdown-timer');
            
            if (timers.length === 0) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                return;
            }

            timers.forEach(timer => {
                const eta = parseInt(timer.dataset.etaTimestamp, 10);
                if (!eta) {
                    timer.style.display = 'none';
                    return;
                }

                const remainingSeconds = Math.floor((eta - now) / 1000);

                if (remainingSeconds <= 0) {
                    timer.style.display = 'none'; // Desaparece al terminar
                    // Opcional: podrías recargar la lista de pedidos aquí si quieres
                } else {
                    timer.style.display = 'block'; // Asegurarse que es visible
                    timer.textContent = `Quedan: ${formatDuration(remainingSeconds)}`;
                }
            });
        }


        // --- Funciones de Renderizado ---

        function renderOrders(docs) {
            ordersList.innerHTML = ''; 
            if (docs.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-500 text-center">Aún no has realizado ningún pedido.</p>';
                return;
            }

            const sortedDocs = docs.sort((a, b) => (b.data().createdAt?.seconds || 0) - (a.data().createdAt?.seconds || 0));

            sortedDocs.forEach(docSnap => {
                const order = docSnap.data();
                const orderId = docSnap.id;
                
                let statusClass = '';
                switch (order.status) {
                    case 'Pendiente': statusClass = 'bg-yellow-100 text-yellow-800'; break;
                    case 'Imprimiendo': statusClass = 'bg-blue-100 text-blue-800'; break;
                    case 'Completado': statusClass = 'bg-green-100 text-green-800'; break;
                    default: statusClass = 'bg-gray-100 text-gray-800';
                }
                
                // (ACTUALIZADO) Usar colorHex y colorName
                const colorHex = order.colorHex || order.color?.toLowerCase() || '#9ca3af'; // Fallback a color
                const colorName = order.colorName || order.color || 'Color'; // Fallback a color

                // (NUEVO) Lógica para botón de cancelar
                const canCancel = order.status === 'Pendiente';
                const cancelButtonHtml = `
                    <button 
                        class="cancel-order-btn mt-2 w-full sm:w-auto text-xs text-red-600 font-medium hover:text-red-800 disabled:text-gray-400" 
                        data-order-id="${orderId}" 
                        data-price-paid="${order.pricePaid}"
                        ${!canCancel ? 'disabled' : ''}>
                        ${canCancel ? 'Cancelar Pedido (Reembolso 80%)' : ''}
                    </button>
                `;
                
                // (NUEVO) Lógica para cuenta atrás
                const etaTimestamp = order.etaTimestamp || 0;
                const countdownHtml = `
                    <p class="text-sm text-blue-700 font-medium countdown-timer mt-1" 
                       data-eta-timestamp="${etaTimestamp}" 
                       style="${etaTimestamp > Date.now() ? '' : 'display: none;'}">
                       Calculando...
                    </p>
                `;
                
                // (MODIFICADO) Mostrar precio en Euros
                const priceInEuros = (order.pricePaid / 250).toFixed(2);

                const orderItem = `
                    <div class="bg-white rounded-lg shadow-md p-4 flex flex-col sm:flex-row items-start justify-between">
                        <div class="flex items-center space-x-4 mb-3 sm:mb-0">
                            <div class="w-10 h-10 rounded-full border-2 border-gray-200" style="background-color: ${colorHex};" title="${colorName}"></div>
                            <div class="min-w-0"> <!-- (NUEVO) Para truncar texto -->
                                <p class="text-lg font-semibold truncate">${order.modelName}</p>
                                <!-- (MODIFICADO) Precio en Euros -->
                                <p class="text-sm text-gray-500">Pagado: ${priceInEuros}€</p>
                                <!-- (NUEVO) Añadir cuenta atrás aquí -->
                                ${order.status === 'Imprimiendo' ? countdownHtml : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end flex-shrink-0"> <!-- (MODIFICADO) -->
                            <span class="text-sm font-medium rounded-full px-3 py-1 ${statusClass} self-start sm:self-auto">
                                ${order.status}
                            </span>
                            <!-- (NUEVO) Añadir botón de cancelar aquí -->
                            ${cancelButtonHtml}
                        </div>
                    </div>
                `;
                ordersList.innerHTML += orderItem;
            });

            // (NUEVO) Adjuntar listeners a los botones de cancelar
            ordersList.querySelectorAll('.cancel-order-btn').forEach(button => {
                button.addEventListener('click', handleUserCancelOrder);
            });
        }

        // --- (NUEVO) Lógica de Cancelación (Usuario) ---
        
        async function handleUserCancelOrder(e) {
            const button = e.currentTarget;
            const { orderId, pricePaid } = button.dataset;

            if (!orderId || !pricePaid) return;

            // (Mejorado) Añadimos un chequeo de doble click
            if (!button.classList.contains('confirm-click')) {
                button.textContent = '¿Seguro? Haz click de nuevo para confirmar';
                button.classList.add('confirm-click', 'text-red-800');
                setTimeout(() => {
                    if (button.classList.contains('confirm-click')) {
                        button.classList.remove('confirm-click', 'text-red-800');
                        button.textContent = 'Cancelar Pedido (Reembolso 80%)';
                    }
                }, 3000); // Resetear tras 3 segundos
                return;
            }


            button.disabled = true;
            button.textContent = 'Cancelando...';
            cancelMessage.textContent = '';
            cancelMessage.classList.add('hidden');

            try {
                // 1. Verificar el estado del pedido (seguridad)
                const adminOrderRef = doc(db, 'artifacts', appId, 'public', 'data', 'allOrders', orderId);
                const adminOrderSnap = await getDoc(adminOrderRef);
                
                if (!adminOrderSnap.exists()) throw new Error("El pedido ya no existe.");
                
                const orderData = adminOrderSnap.data();
                if (orderData.status !== 'Pendiente') {
                    throw new Error("Ya no se puede cancelar el pedido, está siendo procesado.");
                }

                // 2. Calcular reembolso (80%)
                const refundAmountInCoins = Math.floor(parseInt(pricePaid, 10) * 0.80);

                // 3. Reembolsar al usuario
                const userProfileRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
                const userProfileSnap = await getDoc(userProfileRef);
                if (!userProfileSnap.exists()) throw new Error("No se encontró tu perfil de usuario.");
                
                const newCoinBalance = (userProfileSnap.data().coins || 0) + refundAmountInCoins;
                await updateDoc(userProfileRef, { coins: newCoinBalance });

                // 4. Borrar el pedido (ambas copias)
                await deleteDoc(adminOrderRef); // Copia pública

                const userOrderRef = doc(db, 'artifacts', appId, 'users', userId, 'orders', orderId);
                await deleteDoc(userOrderRef); // Copia privada

                // 5. Mostrar mensaje de éxito (en Euros)
                const refundAmountInEuros = (refundAmountInCoins / 250).toFixed(2);
                cancelMessage.textContent = `¡Pedido cancelado! Se han reembolsado ${refundAmountInEuros}€ (80%) a tu cuenta.`;
                cancelMessage.className = 'mb-4 p-3 rounded-md text-sm bg-green-100 text-green-800';
                cancelMessage.classList.remove('hidden');

                // onSnapshot se encargará de refrescar la lista

            } catch (error) {
                console.error("Error al cancelar (usuario):", error);
                cancelMessage.textContent = `Error al cancelar: ${error.message}`;
                cancelMessage.className = 'mb-4 p-3 rounded-md text-sm bg-red-100 text-red-800';
                cancelMessage.classList.remove('hidden');
                button.disabled = false; // Reactivar botón si falla
                button.classList.remove('confirm-click', 'text-red-800');
                button.textContent = 'Cancelar Pedido (Reembolso 80%)';
            }
        }
    </script>
</body>
</html>
